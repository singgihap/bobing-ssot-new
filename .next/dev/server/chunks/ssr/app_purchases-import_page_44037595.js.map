{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Bobing%20Corp/Desktop/bobing-ssot-new/app/purchases-import/page.js"],"sourcesContent":["// app/purchases-import/page.js\r\n\"use client\";\r\nimport { useState, useEffect } from 'react';\r\nimport { db, auth } from '@/lib/firebase';\r\nimport { collection, getDocs, doc, writeBatch, serverTimestamp, query, orderBy } from 'firebase/firestore';\r\nimport { useAuth } from '@/context/AuthContext';\r\nimport * as XLSX from 'xlsx';\r\n\r\nexport default function ImportPurchasesPage() {\r\n    const { user } = useAuth();\r\n    const [warehouses, setWarehouses] = useState([]);\r\n    const [selectedWh, setSelectedWh] = useState('');\r\n    const [logs, setLogs] = useState([]);\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const fetchWh = async () => {\r\n            const q = query(collection(db, \"warehouses\"), orderBy(\"created_at\"));\r\n            const snap = await getDocs(q);\r\n            const data = [];\r\n            snap.forEach(d => { if(d.data().type === 'physical' || !d.data().type) data.push({id:d.id, ...d.data()}) });\r\n            setWarehouses(data);\r\n        };\r\n        fetchWh();\r\n    }, []);\r\n\r\n    const addLog = (msg, type='info') => setLogs(prev => [...prev, {msg, type}]);\r\n\r\n    const handleFile = async (e) => {\r\n        const file = e.target.files[0];\r\n        if (!file || !selectedWh) return alert(\"Pilih gudang dan file!\");\r\n        \r\n        setProcessing(true);\r\n        setLogs([]);\r\n        addLog(\"Membaca file...\", \"info\");\r\n\r\n        try {\r\n            // 1. Load Master Variants\r\n            const varSnap = await getDocs(collection(db, \"product_variants\"));\r\n            const varMap = {};\r\n            varSnap.forEach(d => {\r\n                const v = d.data();\r\n                if(v.sku) varMap[v.sku.toUpperCase().trim()] = { id: d.id, ...v };\r\n            });\r\n\r\n            // 2. Read File\r\n            const reader = new FileReader();\r\n            reader.onload = async (ev) => {\r\n                const workbook = XLSX.read(ev.target.result, { type: 'array' });\r\n                const sheet = workbook.Sheets[workbook.SheetNames[0]];\r\n                const rows = XLSX.utils.sheet_to_json(sheet);\r\n\r\n                if (rows.length === 0) { setProcessing(false); return alert(\"File kosong\"); }\r\n\r\n                // 3. Group by Invoice/PO Ref\r\n                const groups = {};\r\n                rows.forEach(row => {\r\n                    // Auto detect keys (case insensitive)\r\n                    const keys = Object.keys(row);\r\n                    const kInv = keys.find(k => k.match(/invoice|stock in id/i));\r\n                    const kSku = keys.find(k => k.match(/sku|varian id/i));\r\n                    const kQty = keys.find(k => k.match(/qty|jumlah/i));\r\n                    const kCost = keys.find(k => k.match(/cost|harga/i));\r\n\r\n                    if (kInv && kSku && row[kInv]) {\r\n                        const inv = row[kInv];\r\n                        if (!groups[inv]) groups[inv] = [];\r\n                        groups[inv].push({\r\n                            sku: String(row[kSku]).toUpperCase().trim(),\r\n                            qty: parseInt(row[kQty] || 0),\r\n                            cost: parseInt(row[kCost] || 0)\r\n                        });\r\n                    }\r\n                });\r\n\r\n                // 4. Process Groups\r\n                const batch = writeBatch(db);\r\n                let poCount = 0;\r\n\r\n                for (const [inv, items] of Object.entries(groups)) {\r\n                    const validItems = [];\r\n                    let totalAmount = 0;\r\n                    let totalQty = 0;\r\n\r\n                    items.forEach(item => {\r\n                        const v = varMap[item.sku];\r\n                        if (v) {\r\n                            validItems.push({ ...item, variant_id: v.id });\r\n                            totalAmount += (item.qty * item.cost);\r\n                            totalQty += item.qty;\r\n                        } else {\r\n                            addLog(`[SKIP] SKU tidak ditemukan: ${item.sku}`, \"error\");\r\n                        }\r\n                    });\r\n\r\n                    if (validItems.length > 0) {\r\n                        const poRef = doc(collection(db, \"purchase_orders\"));\r\n                        batch.set(poRef, {\r\n                            supplier_name: 'Imported',\r\n                            warehouse_id: selectedWh,\r\n                            order_date: serverTimestamp(),\r\n                            status: 'received_full',\r\n                            total_amount: totalAmount,\r\n                            total_qty: totalQty,\r\n                            payment_status: 'unpaid',\r\n                            notes: `Import Ref: ${inv}`,\r\n                            created_at: serverTimestamp(),\r\n                            created_by: user?.email\r\n                        });\r\n\r\n                        validItems.forEach(item => {\r\n                            const itemRef = doc(collection(db, `purchase_orders/${poRef.id}/items`));\r\n                            batch.set(itemRef, { variant_id: item.variant_id, qty: item.qty, unit_cost: item.cost, subtotal: item.qty*item.cost });\r\n\r\n                            const moveRef = doc(collection(db, \"stock_movements\"));\r\n                            batch.set(moveRef, {\r\n                                variant_id: item.variant_id, warehouse_id: selectedWh, type: 'purchase_in',\r\n                                qty: item.qty, unit_cost: item.cost, ref_id: poRef.id, ref_type: 'purchase_order',\r\n                                date: serverTimestamp(), notes: `Import ${inv}`\r\n                            });\r\n                        });\r\n                        poCount++;\r\n                        addLog(`[OK] PO ${inv}: ${validItems.length} items`, \"success\");\r\n                    }\r\n                }\r\n\r\n                await batch.commit();\r\n                addLog(`SELESAI! Berhasil import ${poCount} PO.`, \"success\");\r\n                setProcessing(false);\r\n            };\r\n            reader.readAsArrayBuffer(file);\r\n\r\n        } catch (e) { \r\n            console.error(e); \r\n            addLog(`ERROR: ${e.message}`, \"error\"); \r\n            setProcessing(false); \r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto space-y-6 fade-in pb-20\">\r\n            <div className=\"card-luxury p-8 bg-lumina-surface border-lumina-border\">\r\n                <h2 className=\"text-xl font-display font-bold text-lumina-text mb-6\">Import Purchase Orders (Stock In)</h2>\r\n                \r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                    {/* Step 1: Warehouse */}\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"block text-xs font-bold text-lumina-gold uppercase tracking-wider mb-1\">1. Target Warehouse</label>\r\n                        <select className=\"input-luxury bg-lumina-base\" value={selectedWh} onChange={e => setSelectedWh(e.target.value)}>\r\n                            <option value=\"\">-- Select Warehouse --</option>\r\n                            {warehouses.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}\r\n                        </select>\r\n                        <p className=\"text-xs text-lumina-muted mt-2\">Select where the stock will be added.</p>\r\n                    </div>\r\n\r\n                    {/* Step 2: Upload */}\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"block text-xs font-bold text-lumina-gold uppercase tracking-wider mb-1\">2. Upload File</label>\r\n                        <div className=\"border-2 border-dashed border-lumina-border rounded-xl p-6 text-center bg-lumina-base/50 hover:bg-lumina-base hover:border-lumina-gold/50 transition-all cursor-pointer relative group h-32 flex flex-col items-center justify-center\">\r\n                            <input type=\"file\" accept=\".csv, .xlsx\" onChange={handleFile} disabled={processing} className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10\" />\r\n                            <svg className=\"w-8 h-8 text-lumina-muted group-hover:text-lumina-gold transition-colors mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12\"/></svg>\r\n                            <p className=\"text-xs font-medium text-lumina-text\">Click to upload .xlsx / .csv</p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Console Log Terminal */}\r\n            <div className=\"bg-[#0B0C10] p-4 rounded-xl border border-lumina-border h-64 overflow-y-auto font-mono text-xs shadow-inner\">\r\n                <div className=\"flex items-center gap-2 mb-3 border-b border-lumina-border pb-2\">\r\n                    <div className=\"w-2 h-2 rounded-full bg-red-500\"></div>\r\n                    <div className=\"w-2 h-2 rounded-full bg-yellow-500\"></div>\r\n                    <div className=\"w-2 h-2 rounded-full bg-green-500\"></div>\r\n                    <span className=\"text-lumina-muted ml-2\">System Log</span>\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                    {logs.length === 0 ? (\r\n                        <span className=\"text-lumina-muted/50 animate-pulse\">Waiting for input...</span>\r\n                    ) : logs.map((l, i) => (\r\n                        <div key={i} className={`flex gap-2 ${l.type==='error'?'text-rose-500':(l.type==='success'?'text-emerald-400':'text-lumina-muted')}`}>\r\n                            <span className=\"opacity-50 select-none\">{'>'}</span>\r\n                            <span>{l.msg}</span>\r\n                        </div>\r\n                    ))}\r\n                    {processing && <div className=\"text-lumina-gold animate-pulse mt-2\">_ Processing data...</div>}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}"],"names":[],"mappings":"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"}}]
}